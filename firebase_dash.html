<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ESP32 Fire Monitor & Control</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, Helvetica, sans-serif; max-width: 720px; margin: 24px auto; padding: 8px; color: #222; }
    h1 { margin-bottom: 6px; }
    .card { border: 1px solid #ddd; padding: 12px; border-radius: 8px; margin-bottom: 12px; }
    .big { font-size: 1.6rem; font-weight: 600; }
    button { padding: 8px 12px; margin: 6px; font-size: 1rem; }
    .btn-danger { background:#d9534f; color:#fff; border:none; }
    .btn-warning { background:#f0ad4e; color:#fff; border:none; }
    .btn-green { background:#5cb85c; color:#fff; border:none; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    label { display:block; margin-bottom:6px; font-weight:600; }
    .status { font-size:1.25rem; font-weight:700; }
    .small { font-size:0.9rem; color:#555; }
  </style>
</head>
<body>
  <h1>ESP32 Fire Monitor & Control</h1>
  <div class="card">
    <div class="row">
      <div>
        <label>System Status</label>
        <div id="status" class="status">—</div>
      </div>
      <div>
        <label>Temperature</label>
        <div id="temp" class="big">— °C</div>
      </div>
      <div>
        <label>Smoke</label>
        <div id="smoke" class="big">—</div>
      </div>
      <div>
        <label>Flame</label>
        <div id="flame" class="big">—</div>
      </div>
    </div>
    <div class="small">Auto/Manual: <span id="automode">—</span></div>
  </div>

  <div class="card">
    <label>Controls</label>
    <div class="row">
      <button id="btnBuzzer" class="btn-warning">Toggle Buzzer</button>
      <button id="btnRelay" class="btn-danger">Toggle Relay (Pump)</button>
      <button id="btnAuto" class="btn-green">Toggle Auto/Manual</button>
      <button id="btnReset" >Reset Controls</button>
    </div>
    <div class="small">Note: In <b>manual</b> mode UI overrides device. In <b>auto</b> mode the device uses local sensors.</div>
  </div>

  <!-- Firebase SDK v9 (modular) -->
  <script type="module">
    // TODO: replace with your firebaseConfig from console
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, update, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

      const firebaseConfig = {
      apiKey: "AIzaSyBr2y_qr3LDmOfnVOa1hSlFMCruOrr89cI",
      authDomain: "esp32-project-cloud.firebaseapp.com",
      databaseURL: "https://esp32-project-cloud-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "esp32-project-cloud",
      storageBucket: "esp32-project-cloud.firebasestorage.app",
      messagingSenderId: "163355177417",
      appId: "1:163355177417:web:b99aff87303085a77cb818"};

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // UI elements
    const elStatus = document.getElementById('status');
    const elTemp = document.getElementById('temp');
    const elSmoke = document.getElementById('smoke');
    const elFlame = document.getElementById('flame');
    const elAuto = document.getElementById('automode');

    const btnBuzzer = document.getElementById('btnBuzzer');
    const btnRelay  = document.getElementById('btnRelay');
    const btnAuto   = document.getElementById('btnAuto');
    const btnReset  = document.getElementById('btnReset');

    const sensorsRef = ref(db, 'sensors');
    const controlsRef = ref(db, 'controls');

    // Listen sensors (realtime)
    onValue(sensorsRef, (snapshot) => {
      const v = snapshot.val();
      if (!v) return;
      elStatus.textContent = v.status || '—';
      elTemp.textContent = (v.temperature !== undefined ? v.temperature.toFixed(1) : '—') + ' °C';
      elSmoke.textContent = (v.smoke !== undefined ? v.smoke : '—');
      elFlame.textContent = (v.flame !== undefined ? v.flame : '—');
    });

    // Listen controls (realtime) to reflect UI
    onValue(controlsRef, (snapshot) => {
      const v = snapshot.val() || {};
      const buz = !!v.buzzer;
      const rel = !!v.relay;
      const am   = (v.autoMode === undefined) ? true : !!v.autoMode;
      elAuto.textContent = am ? 'Auto' : 'Manual';
      btnBuzzer.textContent = buz ? 'Buzzer: ON' : 'Buzzer: OFF';
      btnRelay.textContent  = rel ? 'Relay: ON' : 'Relay: OFF';
      btnAuto.textContent   = am ? 'Switch to Manual' : 'Switch to Auto';
    });

    // Helper to update controls node
    async function updateControls(partialObj) {
      await update(controlsRef, partialObj);
    }

    // Buttons
    btnBuzzer.onclick = async () => {
      // toggle buzzer: read current state and flip
      const snap = await get(controlsRef);
      const cur = snap.val() || {};
      const next = !cur.buzzer;
      await updateControls({ buzzer: next });
    };

    btnRelay.onclick = async () => {
      const snap = await get(controlsRef);
      const cur = snap.val() || {};
      const next = !cur.relay;
      await updateControls({ relay: next });
    };

    btnAuto.onclick = async () => {
      const snap = await get(controlsRef);
      const cur = snap.val() || {};
      const next = !(cur.autoMode === undefined ? true : !!cur.autoMode);
      await updateControls({ autoMode: next });
    };

    btnReset.onclick = async () => {
      // Reset to safe defaults: autoMode true, buzzer false, relay false
      await set(controlsRef, { buzzer: false, relay: false, autoMode: true });
    };

    // Initialize controls if not present
    (async function initControls() {
      const snap = await get(controlsRef);
      if (!snap.exists()) {
        await set(controlsRef, { buzzer: false, relay: false, autoMode: true });
      }
    })();

  </script>
</body>
</html>
